parameters:
- name: pythonVersion
  type: string

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '${{parameters.pythonVersion}}'
    displayName: 'Use Python ${{parameters.pythonVersion}}'     

  - bash: |
      set -ex
      python -m venv venv_msi_build
      source venv_msi_build/scripts/activate
      python -m pip install --upgrade pip
      pip install artifacts-keyring --no-input
      set ARTIFACTS_KEYRING_NONINTERACTIVE_MODE=true
      pip config set global.index-url $(AhjoArtifactsIndexURL) 
      pip install -r ./msi_build_requirements.txt
      python ./msi_build.py bdist_msi
      export AHJO_MSI_TARGET_TYPE="system"
      python ./msi_build.py bdist_msi  
    displayName: "Build release artefacts"

  - task: DotNetCoreCLI@2
    inputs:
      command: 'custom'
      custom: 'tool'
      arguments: 'install --global azuresigntool'
    displayName: Install AzureSignTool

  - bash: |
      AzureSignTool sign -kvu "https://kv-sign-prod-001.vault.azure.net/" -kvi $(ApplicationId) -kvt $(TenantId) -kvs $(ClientSecret) -kvc $(certName) -tr "http://ts.ssl.com" -td sha256 D:/a/1/s/dist/*.msi
    displayName: Sign all msi-files in artefacts-directory

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'dist'
    displayName: Publish msi-file as a pipeline artifact

  - task: powershell@2
    condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
    inputs:
      targetType: 'inline'
      script: |
        Invoke-WebRequest https://aka.ms/downloadazcopy-v10-windows -OutFile azcopy.zip
        Expand-Archive azcopy.zip -DestinationPath D:/a/1/s/temp/azcopy
        Move-Item -Path D:/a/1/s/temp/azcopy/azcopy*/*.exe -Destination D:/a/1/s/temp/azcopy/azcopy.exe
    displayName: Install az copy

  - task: AzureCLI@2
    condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
    inputs:
      azureSubscription: Azure-Systest
      scriptType: 'ps' 
      scriptLocation: 'inlineScript'
      inlineScript: |
        $env:AZCOPY_AUTO_LOGIN_TYPE="SPN"
        $env:AZCOPY_SPA_CLIENT_SECRET="$(ClientSecret)"
        $env:AZCOPY_SPA_CLIENT_ID="$(ApplicationId)"
        $env:AZCOPY_SPA_TENANT_ID="$(TenantId)"
        D:/a/1/s/temp/azcopy/azcopy.exe copy 'D:/\a\1\s\dist\*' 'https://stalmbanksystestdev001.file.core.windows.net/msi-releases/' --recursive --preserve-smb-permissions=true --preserve-smb-info=true
    displayName: Copy msi-files to Azure Storage

  - task: powershell@2
    condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
    inputs:
      targetType: 'inline'
      script: |
        Invoke-WebRequest -Method POST -Uri "https://prod-90.westeurope.logic.azure.com:443/workflows/e66fd92a9c344cc089f461140f4aa8f5/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=oWi7gdwFLBQQhiGNAvIonkyPpp7E_088iqtlCKiX5kY"
    displayName: Trigger MPA-release pipeline